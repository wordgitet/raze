name: hardening

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch:
    inputs:
      run_secs:
        description: "Fuzz smoke seconds per target"
        required: false
        default: "30"

permissions:
  contents: read

concurrency:
  group: hardening-${{ github.ref }}
  cancel-in-progress: false

jobs:
  asan-ubsan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Sanitizer gate
        run: make test-asan-ubsan USE_ISAL=0

  fuzz-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Build fuzz targets
        run: make fuzz-build USE_ISAL=0
      - name: Run bounded fuzz smoke
        run: |
          RUN_SECS="${{ inputs.run_secs }}"
          if [ -z "$RUN_SECS" ]; then
            RUN_SECS=30
          fi
          make fuzz-smoke USE_ISAL=0 RUN_SECS="$RUN_SECS"
